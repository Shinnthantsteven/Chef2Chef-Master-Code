<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chef2Chef | Master Engine</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --brand: #10b981;
            --bg-color: #020617;
            --card-bg: #0f172a;
            --text: #f1f5f9;
            --glass-edge: rgba(255, 255, 255, 0.1);
        }

        body { 
            margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-color); color: var(--text); 
            height: 100vh; overflow: hidden; 
        }

        /* REMOVED ARROWS & STYLED INPUT */
        .stock-entry {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--brand);
            color: var(--brand);
            width: 90px;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            font-weight: 800;
            font-size: 16px;
            outline: none;
            appearance: none;
            -moz-appearance: textfield; /* Firefox hide arrows */
        }
        .stock-entry::-webkit-outer-spin-button,
        .stock-entry::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0; /* Chrome/Safari hide arrows */
        }

        .history-label {
            display: block;
            font-size: 10px;
            color: #64748b;
            margin-top: 5px;
            font-weight: 600;
            cursor: pointer;
            min-height: 12px;
        }

        .top-nav { padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; background: #010409; border-bottom: 1px solid var(--glass-edge); }
        .content-container { overflow-y: auto; height: calc(100vh - 80px); padding: 0 40px 100px 40px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: var(--bg-color); padding: 20px 15px; text-align: left; font-size: 11px; color: #94a3b8; border-bottom: 2px solid var(--brand); z-index: 10; }
        td { padding: 15px; border-bottom: 1px solid var(--glass-edge); font-size: 14px; }
        
        .portal-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); padding: 15px; border-radius: 50px; border: 1px solid var(--glass-edge); display: flex; gap: 20px; }
        #searchIn { background: transparent; border: none; color: white; flex: 1; outline: none; font-weight: 600; }
    </style>
</head>
<body onload="autoLoad()">

    <nav class="top-nav">
        <div style="font-weight:800; font-size:20px;">CHEF2CHEF <span style="color:var(--brand)">MASTER</span></div>
        <div style="font-size:11px; opacity:0.6;">ROOT: STEVE</div>
    </nav>

    <div class="content-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>DESCRIPTION</th>
                    <th style="width:120px">PHYSICAL STOCK</th>
                    <th>QB QTY</th>
                    <th>UNIT</th>
                    <th>SUPPLIER</th>
                </tr>
            </thead>
            <tbody id="list"></tbody>
        </table>
    </div>

    <div class="portal-bar">
        <input type="text" id="searchIn" placeholder="Search items...">
        <button onclick="clearStorage()" style="background:#ef4444; color:white; border:none; padding:8px 20px; border-radius:20px; cursor:pointer; font-weight:700;">RESET ALL</button>
    </div>

    <script>
        let db = [];
        // persistentStorage for math strings (e.g., "5+5")
        let stockData = JSON.parse(localStorage.getItem('c2c_v2_math')) || {};

        async function autoLoad() {
            try {
                const res = await fetch('data.csv?v=' + Date.now());
                const text = await res.text();
                const wb = XLSX.read(text, { type: 'string' });
                db = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" });
                render(db);
            } catch(e) { console.error("CSV not found. Please upload manually."); }
        }

        function render(data) {
            const list = document.getElementById('list');
            list.innerHTML = data.map(r => {
                const id = r.Item || r.ID;
                const mathString = stockData[id] || "";
                const total = mathString ? eval(mathString) : "";

                return `
                <tr>
                    <td style="color:#64748b; font-weight:700;">${id}</td>
                    <td style="font-weight:800;">${r.Description}</td>
                    <td>
                        <input type="text" class="stock-entry" 
                            id="input-${id}"
                            placeholder="ENTRY" 
                            value="${total}"
                            onfocus="handleFocus('${id}')"
                            onkeydown="if(event.key==='Enter') handleSave('${id}', this.value)">
                        <span class="history-label" onclick="alert('Breakdown: ${mathString}')">
                            ${mathString ? 'Click to see math' : ''}
                        </span>
                    </td>
                    <td style="color:#38bdf8; font-weight:800;">${r['Quantity On Q.B'] || 0}</td>
                    <td>${r['U/M'] || ''}</td>
                    <td style="color:#a78bfa;">${r['Preferred Supplier'] || ''}</td>
                </tr>`;
            }).join('');
        }

        // When you click the box, if there is data, it adds the "+" automatically
        function handleFocus(id) {
            const input = document.getElementById(`input-${id}`);
            const currentMath = stockData[id] || "";
            if(currentMath !== "") {
                input.value = currentMath + "+";
            }
        }

        // When you hit Enter, it calculates and saves
        function handleSave(id, value) {
            try {
                // Remove trailing plus if user didn't type anything after it
                let cleanValue = value.endsWith('+') ? value.slice(0, -1) : value;
                if(!cleanValue) return;

                // Test if math is valid
                const result = eval(cleanValue);
                
                stockData[id] = cleanValue;
                localStorage.setItem('c2c_v2_math', JSON.stringify(stockData));
                
                // Update UI to show total
                const input = document.getElementById(`input-${id}`);
                input.value = result;
                input.blur(); // Unfocus
                render(db); // Refresh list to update "Click to see math" labels
            } catch(e) {
                alert("Invalid math! Use numbers and + only.");
            }
        }

        function clearStorage() {
            if(confirm("Delete all counted stock?")) {
                localStorage.removeItem('c2c_v2_math');
                stockData = {};
                render(db);
            }
        }

        document.getElementById('searchIn').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = db.filter(r => (r.Description || "").toLowerCase().includes(term) || (r.Item || "").toLowerCase().includes(term));
            render(filtered);
        });
    </script>
</body>
</html>
